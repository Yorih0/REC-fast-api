<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/toast.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/profile_user.css">
</head>
<body>
    <main class="main-container">
        <header class="header">
            <div class="logo" onclick="Back()"><div class="shine">ReCharge</div></div>
            <nav class="nav">
                <button class="services-btn" onclick="Exit()">–í—ã–π—Ç–∏</button>
            </nav>
        </header>

        <section class="profile-section">
            <div class="profile-header">
                <div class="profile-avatar">
                    <div class="avatar-circle">
                        <span id="avatar-initial">A</span>
                    </div>
                </div>
                <div class="profile-info">
                    <h1 class="profile-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h1>
                    <p class="profile-role" id="role">Admin</p>
                </div>
            </div>

            <div class="profile-details">
                <div class="detail-card">
                    <div class="detail-icon">üëë</div>
                    <div class="detail-content">
                        <div class="detail-label">–†–æ–ª—å</div>
                        <div class="detail-value" id="role-display">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">üìã</div>
                    <div class="detail-content">
                        <div class="detail-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                        <div class="detail-value" id="total-orders">0</div>
                    </div>
                </div>
                <div class="detail-card">
                    <div class="detail-icon">‚öôÔ∏è</div>
                    <div class="detail-content">
                        <div class="detail-label">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
                        <div class="detail-value">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="orders-section">
            <h2 class="orders-title">–í—Å–µ –∑–∞–∫–∞–∑—ã</h2>
            <div id="ContenerForOrders" class="orders-container">
                <div class="no-orders" id="no-orders" style="display: none;">
                    <p>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                </div>
            </div>
        </section>
        <div id="workerModal" class="modal">
        <div class="modal-content">
            <h3>–ù–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</h3>

            <select id="workerSelect">
            <option disabled selected>–ó–∞–≥—Ä—É–∑–∫–∞...</option>
            </select>

            <div class="modal-actions">
            <button class="services-btn" onclick="confirmAssign()">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
            <button class="services-btn cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        </div>

    </main>
    <script src="js/General.js"></script>
    <script>
        const formData = { hashkey: getCookie('hashkey'),};

        function Exit()
        {
            document.cookie = "hashkey=; path=/; max-age=0";
            showToast("–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞","info");
            setTimeout(() => {
                window.location.href = "/";
            }, 1000);
        }

        function getStatusColor(status) {
            const statusColors = {
                '–û–±—Ä–∞–±–æ—Ç–∫–∞': '#ffa500',
                '–í —Ä–∞–±–æ—Ç–µ': '#2196F3',
                '–í—ã–ø–æ–ª–Ω–µ–Ω–æ': '#4CAF50',
                '–û—Ç–º–µ–Ω–µ–Ω–æ': '#f44336'
            };
            return statusColors[status] || '#9e9e9e';
        }

        document.addEventListener("DOMContentLoaded", async () => {
            if (!formData.hashkey) 
            {
                showToast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω", "error");
                setTimeout(() => {
                    window.location.href = "/";
                }, 1000);
                return;
            }
            try 
            {
                const response = await fetch("/load_profile_admin",{
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (!response.ok) 
                {
                    showToast(data.message || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è", "error");
                    return;
                }
                
                document.getElementById("role-display").textContent = "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
                document.getElementById("total-orders").textContent = data.count || 0;
                
                if(data.count > 0)
                {
                    document.getElementById("no-orders").style.display = "none";
                    CreatorDivs(data.count,"ContenerForOrders",data.orders);
                }
                else
                {
                    document.getElementById("no-orders").style.display = "block";
                }

            } 
            catch (error) 
            { 
                showToast("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º", "error");
            }
        });

        function CreatorDivs(n,where,orders)
        {
            try
            {
                const container = document.getElementById(where);
                container.innerHTML = "";
                
                for (let i = 1; i <= n; i++)
                {
                    //–∫–∞—Ä—Ç–æ—á–∫–∞
                    const order = orders[`order-${i}`];
                    const orderCard = document.createElement("div");
                    orderCard.className = "order-card";
                    orderCard.addEventListener("click", () => {
                        openAssignModal(order.id);
                    });

                    //–∑–∞–≥–æ–ª–æ–≤–æ–∫
                    const orderHeader = document.createElement("div");
                    orderHeader.className = "order-header";

                    const orderNumber = document.createElement("div");
                    orderNumber.className = "order-number";
                    orderNumber.textContent = `–ó–∞–∫–∞–∑ #${i}`;
                    orderNumber.dataset.orderId = order.id;
                    orderHeader.appendChild(orderNumber);
                    
                    const orderStatus = document.createElement("div");
                    orderStatus.className = "order-status";
                    orderStatus.textContent = order.status || "–û–±—Ä–∞–±–æ—Ç–∫–∞";
                    orderStatus.style.backgroundColor = getStatusColor(order.status || "–û–±—Ä–∞–±–æ—Ç–∫–∞");
                    orderHeader.appendChild(orderStatus);
                    
                    orderCard.appendChild(orderHeader);

                    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ
                    const carInfo = document.createElement("div");
                    carInfo.className = "order-section";
                    
                    const carTitle = document.createElement("div");
                    carTitle.className = "section-title";
                    carTitle.textContent = "üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å";
                    carInfo.appendChild(carTitle);
                    
                    const carDetails = document.createElement("div");
                    carDetails.className = "section-content";
                    
                    const brandRow = document.createElement("div");
                    brandRow.className = "info-row";
                    brandRow.innerHTML = `<span class="info-label">–ú–∞—Ä–∫–∞:</span><span class="info-value">${order.brand}</span>`;
                    carDetails.appendChild(brandRow);
                    
                    const modelRow = document.createElement("div");
                    modelRow.className = "info-row";
                    modelRow.innerHTML = `<span class="info-label">–ú–æ–¥–µ–ª—å:</span><span class="info-value">${order.model}</span>`;
                    carDetails.appendChild(modelRow);
                    
                    const plateRow = document.createElement("div");
                    plateRow.className = "info-row";
                    plateRow.innerHTML = `<span class="info-label">–ù–æ–º–µ—Ä:</span><span class="info-value">${order.license_plate}-${order.region}</span>`;
                    carDetails.appendChild(plateRow);
                    
                    carInfo.appendChild(carDetails);
                    orderCard.appendChild(carInfo);

                    // –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
                    const problemSection = document.createElement("div");
                    problemSection.className = "order-section";
                    
                    const problemTitle = document.createElement("div");
                    problemTitle.className = "section-title";
                    problemTitle.textContent = "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞";
                    problemSection.appendChild(problemTitle);
                    
                    const problemText = document.createElement("div");
                    problemText.className = "section-text";
                    problemText.textContent = order.description_problem;
                    problemSection.appendChild(problemText);
                    
                    orderCard.appendChild(problemSection);

                    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ
                    const workSection = document.createElement("div");
                    workSection.className = "order-section";
                    
                    const workTitle = document.createElement("div");
                    workTitle.className = "section-title";
                    workTitle.textContent = "üõ†Ô∏è –†–∞–±–æ—Ç–∞";
                    workSection.appendChild(workTitle);
                    
                    const workContent = document.createElement("div");
                    workContent.className = "section-content";
                        
                    const workerRow = document.createElement("div");
                    workerRow.className = "info-row";
                    workerRow.innerHTML = `<span class="info-label">–ú–∞—Å—Ç–µ—Ä:</span><span class="info-value"> ${order.worker_id}</span>`;
                    workContent.appendChild(workerRow);
                    
                    
                    const workText = document.createElement("div");
                    workText.className = "section-text";
                    workText.textContent = order.description_work;
                    workContent.appendChild(workText);
                    
                    
                    workSection.appendChild(workContent);
                    orderCard.appendChild(workSection);
                    

                    
                    if (order.status !== "–í—ã–ø–æ–ª–Ω–µ–Ω–æ" && order.status !== "–û—Ç–º–µ–Ω–µ–Ω–æ") 
                    {
                        const cancelBtn = document.createElement("button");
                        cancelBtn.className = "services-btn order-cancel-btn";
                        cancelBtn.textContent = "–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑";
                        cancelBtn.type = "button";
                        cancelBtn.onclick = function() { cancelOrder(order.id); };
                        orderCard.appendChild(cancelBtn);
                    }

                    container.appendChild(orderCard);
                }
            }
            catch(error)
            {
                showToast(error,"error");
                console.log(error);
            }
        }

        async function assignWorker(orderId) 
        {

            showToast("–§—É–Ω–∫—Ü–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ", "info");
        }
        async function cancelOrder(orderId) 
        {
            const formData = {
                hashkey: getCookie('hashkey'),
                order_id: orderId
            };
            try 
            {
                const response = await fetch('/Del_order', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (response.ok) 
                {
                    showToast(result.message, "success");
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } 
                else 
                {
                    showToast(result.message, "error");
                }
            }
            catch (err)
            {
                showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
            }
            return false;
        }
    </script>
    
    <script>
        let currentOrderId = null;

        function openAssignModal(orderId) {
            currentOrderId = orderId;
            document.getElementById("workerModal").style.display = "flex";
            loadWorkers();
        }

        function closeModal() {
            document.getElementById("workerModal").style.display = "none";
        }

        async function loadWorkers() {
            const select = document.getElementById("workerSelect");
            select.innerHTML = "<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>";

            try {
                const res = await fetch("/get_workers");
                if (!res.ok) {
                    throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤");
                }
                const workers = await res.json();

                select.innerHTML = "";
                workers.forEach(w => {
                    const option = document.createElement("option");
                    option.value = w.id;
                    option.textContent = w.name;
                    select.appendChild(option);
                });
            } catch (err) {
                select.innerHTML = "<option>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>";
                showToast(err.message, "error");
            }
        }

        async function confirmAssign() {
            const workerId = document.getElementById("workerSelect").value;
            if (!workerId) {
                showToast("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞", "error");
                return;
            }

            try {
                const res = await fetch("/assign_worker", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        order_id: currentOrderId,
                        worker_id: workerId
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    showToast("–ú–∞—Å—Ç–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω", "success");
                    closeModal();
                    location.reload();
                } else {
                    showToast(data.message || "–û—à–∏–±–∫–∞", "error");
                }
            } catch (err) {
                showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", "error");
            }
        }


    </script>
</body>
</html>
