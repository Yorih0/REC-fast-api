<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ü—Ä–æ—Ñ–∏–ª—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="css/toast.css">
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/profile_worker.css">
</head>

<body>

<main class="main-container">

<header class="header">
  <div class="logo" onclick="Back()"><div class="shine">ReCharge</div></div>
  <nav class="nav">
    <button class="services-btn" onclick="Exit()">–í—ã–π—Ç–∏</button>
  </nav>
</header>

<section class="profile-section">
  <div class="profile-header">
    <div class="profile-avatar">
      <div class="avatar-circle"><span>W</span></div>
    </div>
    <div class="profile-info">
      <h1 class="profile-name">–†–∞–±–æ—Ç–Ω–∏–∫</h1>
      <p class="profile-role">Worker</p>
    </div>
  </div>

  <div class="profile-details">
    <div class="detail-card">
      <div class="detail-icon">üßë‚Äçüîß</div>
      <div class="detail-content">
        <div class="detail-label">–†–æ–ª—å</div>
        <div class="detail-value">–†–∞–±–æ—Ç–Ω–∏–∫</div>
      </div>
    </div>
    <div class="detail-card">
      <div class="detail-icon">üìã</div>
      <div class="detail-content">
        <div class="detail-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</div>
        <div class="detail-value" id="total-orders">0</div>
      </div>
    </div>
  </div>
</section>

<section class="orders-section">
  <h2 class="orders-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
  <div id="ContenerForOrders" class="orders-container">
    <div id="no-orders" class="no-orders" style="display:none">
      –ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç
    </div>
  </div>
</section>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û -->
<div id="workerModal" class="modal">
  <div class="modal-content">

    <h3>–†–∞–±–æ—Ç–∞ —Å –∑–∞–∫–∞–∑–æ–º</h3>

    <label>–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</label>
    <select id="statusSelect">
      <option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
      <option value="–í—ã–ø–æ–ª–Ω–µ–Ω–æ">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
      <option value="–û—Ç–º–µ–Ω–µ–Ω–æ">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
    </select>

    <label>–û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã</label>
    <textarea id="workDescription" placeholder="–í–≤–µ–¥–∏—Ç–µ —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ..."></textarea>


    <div class="modal-actions">
      <button class="services-btn cancel" onclick="closeModal()">–ù–∞–∑–∞–¥</button>
      <button class="services-btn" onclick="saveChanges()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="services-btn success" onclick="finishOrder()">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
    </div>

  </div>
</div>

</main>

<script src="js/General.js"></script>

<script>
const formData = { hashkey: getCookie('hashkey') };

function Exit(){
  document.cookie = "hashkey=; path=/; max-age=0";
  showToast("–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞","info");
  setTimeout(()=>location.href="/",1000);
}

let currentOrderId = null;
load_work();
async function load_work(){
  if(!formData.hashkey){
    showToast("–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω","error");
    location.href="/";
    return;
  }
  const res = await fetch("/load_profile_worker",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(formData)
  });

  const data = await res.json();

  document.getElementById("total-orders").textContent = data.count;

  if(data.count){
    CreatorDivs(data.count,"ContenerForOrders",data.orders);
  } else {
    document.getElementById("no-orders").style.display="block";
  }
}
function getStatusColor(status) {
    const statusColors = {
        '–û–±—Ä–∞–±–æ—Ç–∫–∞': '#ffa500',
        '–í —Ä–∞–±–æ—Ç–µ': '#2196F3',
        '–í—ã–ø–æ–ª–Ω–µ–Ω–æ': '#4CAF50',
        '–û—Ç–º–µ–Ω–µ–Ω–æ': '#f44336'
    };
    return statusColors[status] || '#9e9e9e';
}
function CreatorDivs(n,where,orders)
{
    try
    {
        const container = document.getElementById(where);
        container.innerHTML = "";
        
        for (let i = 1; i <= n; i++)
        {
            //–∫–∞—Ä—Ç–æ—á–∫–∞
            const order = orders[`order-${i}`];
            const orderCard = document.createElement("div");
            orderCard.className = "order-card";
            orderCard.addEventListener("click", () => {
                openAssignModal(order.id);
            });

            //–∑–∞–≥–æ–ª–æ–≤–æ–∫
            const orderHeader = document.createElement("div");
            orderHeader.className = "order-header";

            const orderNumber = document.createElement("div");
            orderNumber.className = "order-number";
            orderNumber.textContent = `–ó–∞–∫–∞–∑ #${i}`;
            orderNumber.dataset.orderId = order.id;
            orderHeader.appendChild(orderNumber);
            
            const orderStatus = document.createElement("div");
            orderStatus.className = "order-status";
            orderStatus.textContent = order.status || "–û–±—Ä–∞–±–æ—Ç–∫–∞";
            orderStatus.style.backgroundColor = getStatusColor(order.status || "–û–±—Ä–∞–±–æ—Ç–∫–∞");
            orderHeader.appendChild(orderStatus);
            
            orderCard.appendChild(orderHeader);


            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–º–æ–±–∏–ª–µ
            const carInfo = document.createElement("div");
            carInfo.className = "order-section";
            
            const carTitle = document.createElement("div");
            carTitle.className = "section-title";
            
            //–ø–æ–ª
            const phone = document.createElement("div");
            phone.className = "order-phone";
            phone.textContent = order.phone;
            carInfo.appendChild(phone);

            const email = document.createElement("div");
            email.className = "order-email";
            email.textContent = order.email;
            carInfo.appendChild(email);
            //
            carTitle.textContent = "üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å";
            carInfo.appendChild(carTitle);
            
            const carDetails = document.createElement("div");
            carDetails.className = "section-content";
            
            const brandRow = document.createElement("div");
            brandRow.className = "info-row";
            brandRow.innerHTML = `<span class="info-label">–ú–∞—Ä–∫–∞:</span><span class="info-value">${order.brand}</span>`;
            carDetails.appendChild(brandRow);
            
            const modelRow = document.createElement("div");
            modelRow.className = "info-row";
            modelRow.innerHTML = `<span class="info-label">–ú–æ–¥–µ–ª—å:</span><span class="info-value">${order.model}</span>`;
            carDetails.appendChild(modelRow);
            
            const plateRow = document.createElement("div");
            plateRow.className = "info-row";
            plateRow.innerHTML = `<span class="info-label">–ù–æ–º–µ—Ä:</span><span class="info-value">${order.license_plate}-${order.region}</span>`;
            carDetails.appendChild(plateRow);
            
            carInfo.appendChild(carDetails);
            orderCard.appendChild(carInfo);

            // –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
            const problemSection = document.createElement("div");
            problemSection.className = "order-section";
            
            const problemTitle = document.createElement("div");
            problemTitle.className = "section-title";
            problemTitle.textContent = "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞";
            problemSection.appendChild(problemTitle);
            
            const problemText = document.createElement("div");
            problemText.className = "section-text";
            problemText.textContent = order.description_problem;
            problemSection.appendChild(problemText);
            
            orderCard.appendChild(problemSection);

            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ
            const workSection = document.createElement("div");
            workSection.className = "order-section";
            
            const workTitle = document.createElement("div");
            workTitle.className = "section-title";
            workTitle.textContent = "üõ†Ô∏è –†–∞–±–æ—Ç–∞";
            workSection.appendChild(workTitle);
            
            const workContent = document.createElement("div");
            workContent.className = "section-content";
            
            const workText = document.createElement("div");
            workText.className = "section-text";
            workText.textContent = order.description_work;
            workContent.appendChild(workText);
            
            
            workSection.appendChild(workContent);
            orderCard.appendChild(workSection);

            container.appendChild(orderCard);
        }
    }
    catch(error)
    {
        showToast(error,"error");
        console.log(error);
    }
}

function openAssignModal(orderId) {
    currentOrderId = orderId;
    document.getElementById("workerModal").style.display = "flex";

    // –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω—É–∂–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
    const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
    if (!card) return;

    // –ë–µ—Ä—ë–º —Ç–µ–∫—Å—Ç —Ä–∞–±–æ—Ç—ã –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
    const textBlock = card.querySelector(".work-description");
    const textarea = document.getElementById("workDescription");

    if (textBlock && textarea) {
        textarea.value = textBlock.textContent.trim();
    }
}


function closeModal(){
  document.getElementById("workerModal").style.display="none";
}

async function saveChanges(){
  const status = document.getElementById("statusSelect").value;
  const desc = document.getElementById("workDescription").value;

  const response = await fetch("/update_order",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({order_id:currentOrderId,status,description_work:desc})
  });
  const result = await response.json();
  if(response.ok){
    showToast(result.message,"success");
    closeModal();
    load_work();
  } else showToast(result.message ,"error");
}

async function finishOrder(){
  // const res = await fetch("/finish_order",{
  //   method:"POST",
  //   headers:{"Content-Type":"application/json"},
  //   body:JSON.stringify({order_id:currentOrderId})
  // });

  // if(res.ok){
  //   showToast("–ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω","success");
  //   closeModal();
  //   location.reload();
  // } else showToast("–û—à–∏–±–∫–∞","error");
}
</script>

</body>
</html>
